#!/bin/sh

# Pre-push hook - verify lockfile consistency before pushing to CI
echo "üîí Verifying lockfile consistency..."

# Temporarily hide pnpm-workspace.yaml (local dev overrides)
# This file is gitignored but affects lockfile generation
if [ -f pnpm-workspace.yaml ]; then
  mv pnpm-workspace.yaml pnpm-workspace.yaml.pre-push-backup
  WORKSPACE_HIDDEN=1
fi

# Restore workspace file on exit (even on failure)
cleanup() {
  if [ "$WORKSPACE_HIDDEN" = "1" ] && [ -f pnpm-workspace.yaml.pre-push-backup ]; then
    mv pnpm-workspace.yaml.pre-push-backup pnpm-workspace.yaml
  fi
}
trap cleanup EXIT

# Save original lockfile hash
ORIGINAL_HASH=$(git hash-object pnpm-lock.yaml 2>/dev/null || echo "none")

# Regenerate lockfile (fast, lockfile-only mode)
pnpm install --lockfile-only 2>/dev/null

# Check if lockfile would change
if ! git diff --quiet pnpm-lock.yaml 2>/dev/null; then
  # Restore original lockfile
  git checkout pnpm-lock.yaml 2>/dev/null

  echo ""
  echo "‚ùå Lockfile mismatch detected!"
  echo ""
  echo "Your pnpm-lock.yaml is out of sync with package.json."
  echo "This will cause CI to fail with ERR_PNPM_LOCKFILE_CONFIG_MISMATCH."
  echo ""
  echo "To fix this, run:"
  echo "  pnpm install"
  echo ""
  echo "Then commit the updated pnpm-lock.yaml and try again."
  exit 1
fi

echo "‚úÖ Lockfile is in sync - safe to push"
